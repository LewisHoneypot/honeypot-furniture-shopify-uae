<script>
  // console.log({{ product.metafields.custom | json }});
  // console.log({{ product.metafields.custom.cylindo_parent | json | upcase }});
  // console.log({{ product.metafields.Details.Colour | json | upcase }});

  let colour = {{ product.metafields.Details.Colour | json | upcase }};
</script>

<!-- Upholstery Selectors -->
{% comment %}
  <select name="UPHOLSTERY">
    <option value="BEIGE">Beige</option>
    <option value="BLUE">Blue</option>
    <option value="DARK GREY">Dark Grey</option>
    <option value="GREEN">Green</option>
    <option value="LIGHT GREY">Light Grey</option>
    <option value="NATURAL">Natural</option>
    <option value="STONE">Stone</option>
  </select>
{% endcomment %}

<!-- Cylindo Viewer -->
<cylindo-viewer
  slot="placeholder"
  customer-id="6981"
  code="{{ product.metafields.custom.cylindo_parent | upcase }}"
>
  <cylindo-360></cylindo-360>
  <cylindo-360-frame frame="4"></cylindo-360-frame>
  <cylindo-360-frame frame="9"></cylindo-360-frame>
  <cylindo-360-frame frame="13"></cylindo-360-frame>
  <cylindo-360-frame frame="17"></cylindo-360-frame>
  <cylindo-thumbnail-bar></cylindo-thumbnail-bar>
</cylindo-viewer>

<script>
  customElements.whenDefined('cylindo-viewer').then(() => {
    const viewer = document.querySelector('cylindo-viewer');
    const upholsterySelect = document.querySelector("select[name='UPHOLSTERY']");

    // Fix layout
    const tryFixViewerLayout = () => {
      const shadowRoot = viewer.shadowRoot;
      if (!shadowRoot) return;

      const rootDiv = shadowRoot.querySelector('.root.inactive');
      if (rootDiv) {
        rootDiv.classList.remove('inactive');
        rootDiv.style.width = '100%';
        rootDiv.style.height = '100%';
        // console.log("âœ… Viewer layout fixed.");
      }
    };

    setTimeout(tryFixViewerLayout, 1000);

    viewer.features = {
      UPHOLSTERY: colour,
    };

    // Event listener for manual or simulated dropdown changes
    upholsterySelect.addEventListener('change', (event) => {
      const value = event.target.value;
      viewer.features = {
        UPHOLSTERY: value,
      };
      // console.log(`ðŸŽ¨ Feature updated: UPHOLSTERY = ${value}`);
    });

    viewer.addEventListener('viewer-ready', () => {
      // console.log("ðŸŸ¢ Viewer is ready.");

      // Delay before applying initial feature to ensure internal state is ready
      setTimeout(() => {
        // Trigger change manually (simulate user interaction)
        upholsterySelect.dispatchEvent(new Event('input', { bubbles: true }));
        upholsterySelect.dispatchEvent(new Event('change', { bubbles: true }));
      }, 1000); // <-- Delay increased to ensure viewer is 100% ready
    });
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const waitForViewer = async () => {
      await customElements.whenDefined('cylindo-360');
      const viewer = document.querySelector('cylindo-viewer');
      if (!viewer) return console.warn('âŒ cylindo-viewer not found');

      const applyObjectFit = (root, label) => {
        const imgs = root.querySelectorAll('img');
        imgs.forEach((img) => {
          img.style.objectFit = 'cover';
        });
        // console.log(`âœ… Applied object-fit to ${imgs.length} image(s) in ${label}`);
      };

      const observe360Viewer = () => {
        const tryApply = () => {
          const threeSixty = viewer.shadowRoot?.querySelector('cylindo-three-sixty');
          if (threeSixty?.shadowRoot) {
            applyObjectFit(threeSixty.shadowRoot, '360-view');

            const observer = new MutationObserver(() => {
              applyObjectFit(threeSixty.shadowRoot, '360-view');
            });

            observer.observe(threeSixty.shadowRoot, {
              childList: true,
              subtree: true,
              attributes: true,
            });

            // console.log('ðŸ‘€ Observing 360-view for changes.');
            return true;
          }
          return false;
        };

        // Watch viewer's shadowRoot for <cylindo-three-sixty> being added again
        const viewerObserver = new MutationObserver(() => {
          tryApply();
        });

        if (viewer.shadowRoot) {
          viewerObserver.observe(viewer.shadowRoot, {
            childList: true,
            subtree: true,
          });
        }

        // Try initially in case 360 is already there
        tryApply();
      };

      const observeFrameImages = () => {
        const checkFrames = () => {
          const contentArea = viewer.shadowRoot?.querySelector('[part="viewer-content"]');
          if (!contentArea) return;

          const frameDivs = contentArea.querySelectorAll('div');
          frameDivs.forEach((div) => applyObjectFit(div, 'frame'));
        };

        checkFrames();

        const observer = new MutationObserver(() => {
          checkFrames();
        });

        viewer.shadowRoot &&
          observer.observe(viewer.shadowRoot, {
            childList: true,
            subtree: true,
            attributes: true,
          });
      };

      const waitUntilReady = setInterval(() => {
        if (viewer.shadowRoot?.querySelector('[part="viewer-content"]')) {
          clearInterval(waitUntilReady);
          observe360Viewer();
          observeFrameImages();

          // Z-index fix for iPhone overlay issue
          const rootEl = viewer.shadowRoot.querySelector('.root');
          if (rootEl) {
            rootEl.style.zIndex = '9999';
            rootEl.style.position = 'relative';
            console.log('âœ… Applied z-index fix to .root inside shadow DOM');
          }

          // Optional fallback
          viewer.style.zIndex = '9999';
        }
      }, 200);
    };

    waitForViewer();
  });
</script>
