<section class="honeypot-signup">
  <div class="honeypot-container">
    <div class="honeypot-text col-md-6 my-auto">
      <h2>Join The Honeypot Club!</h2>
      <p>Sign up for first access to Honeypotâ€™s newest collections, special offers, and member-only moments.</p>
    </div>

    <div class="col-md-6">
      <div class="klaviyo-form-Ud99yN"></div>
    </div>

    {% comment %}
      <form class="honeypot-form" method="post" action="#">
        <div class="form-group">
          <div class="input-wrapper">
            <input type="text" id="honeypot-phone" name="phone" placeholder="Phone Number" required>
            <span class="icon">
              {% if section.settings.phone_icon != blank %}
                <img
                  src="{{ section.settings.phone_icon | image_url: width: 40 }}"
                  width="20"
                  height="20"
                  alt="Phone Icon"
                >
              {% endif %}
            </span>
          </div>
        </div>

        <div class="form-group">
          <div class="input-wrapper">
            <input type="email" id="honeypot-email" name="email" placeholder="Email" required>
            <span class="icon">
              {% if section.settings.email_icon != blank %}
                <img
                  src="{{ section.settings.email_icon | image_url: width: 40 }}"
                  width="20"
                  height="20"
                  alt="Email Icon"
                >
              {% endif %}
            </span>
          </div>
        </div>

        <button type="submit" class="honeypot-btn">SUBMIT</button>
      </form>
    {% endcomment %}
  </div>
</section>

{% schema %}
{
  "name": "Honeypot Signup",
  "enabled_on": {
    "templates": ["index", "page"]
  },
  "settings": [
    { "type": "image_picker", "id": "phone_icon", "label": "Phone Icon" },
    { "type": "image_picker", "id": "email_icon", "label": "Email Icon" }
  ],
  "presets": [
    { "name": "Honeypot Signup Section" }
  ]
}
{% endschema %}

<script>
function selectUAE() {
  const interval = setInterval(() => {
    const form = document.querySelector('.klaviyo-form-Ud99yN');
    if (!form) return;

    const countryButton = form.querySelector('button[aria-label="Search Countries"]');
    if (!countryButton) return;

    console.log('Opening country dropdown');
    countryButton.click(); // open dropdown

    // Poll until the UAE option exists
    const optionInterval = setInterval(() => {
      const options = Array.from(document.querySelectorAll('div[role="option"]'));
      const uaeOption = options.find(option => {
        const span = option.querySelector('span');
        return span && span.textContent.trim() === 'United Arab Emirates';
      });

      if (uaeOption) {
        console.log('Selecting UAE');
        uaeOption.click(); // triggers Klaviyo logic
        clearInterval(optionInterval);
        clearInterval(interval);
      }
    }, 50);

  }, 50);
}

// Observe the form entering the viewport
const form = document.querySelector('.klaviyo-form-Ud99yN');
if (form) {
  const observer = new IntersectionObserver((entries, obs) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        console.log('Form in view, selecting UAE');
        selectUAE();
        obs.disconnect(); // only trigger once
      }
    });
  }, { threshold: 0.1 });

  observer.observe(form);
}
</script>
