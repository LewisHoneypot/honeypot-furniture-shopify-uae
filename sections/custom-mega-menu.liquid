{% schema %}
{
  "name": "Custom Mega Menu",
  "settings": [
    {
      "type": "paragraph",
      "content": "By default, this section shows the 'Honeypot' standard menu. To use your own menus, select them below."
    },
    {
      "type": "header",
      "content": "Dynamic Menu Configuration"
    },
    {
      "type": "link_list",
      "id": "menu_products",
      "label": "Desktop: Menu for 'Shop Products'",
      "info": "Overrides default content."
    },
    {
      "type": "link_list",
      "id": "menu_custom",
      "label": "Desktop: Menu for 'Shop Custom'",
      "info": "Overrides default content."
    },
    {
      "type": "header",
      "content": "Mobile Menu Configuration"
    },
    {
      "type": "link_list",
      "id": "mobile_menu_products",
      "label": "Mobile: Menu for 'Shop Products'",
      "info": "Select a simplified menu for mobile. If blank, uses Desktop menu."
    },
    {
      "type": "link_list",
      "id": "mobile_menu_custom",
      "label": "Mobile: Menu for 'Shop Custom'",
      "info": "Select a simplified menu for mobile. If blank, uses Desktop menu."
    },
    {
      "type": "header",
      "content": "Branding"
    },
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Logo Image"
    },
    {
      "type": "range",
      "id": "logo_width",
      "min": 50,
      "max": 300,
      "step": 10,
      "default": 140,
      "unit": "px",
      "label": "Logo Width"
    },
    {
      "type": "checkbox",
      "id": "show_mega_menu",
      "label": "Show Custom Mega Menu",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "promo",
      "name": "Promo / Image",
      "settings": [
        {
          "type": "text",
          "id": "trigger_name",
          "label": "Trigger Link Name",
          "info": "e.g. 'Sofas'. Shows this block when hovering the sidebar link."
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "heading",
          "label": "Heading"
        },
        {
          "type": "richtext",
          "id": "text",
          "label": "Text"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link Url"
        }
      ]
    },
    {
      "type": "sidebar_section",
      "name": "Sidebar Section (Shop By)",
      "settings": [
        {
          "type": "select",
          "id": "tab",
          "label": "Assign to Tab",
          "options": [
            { "value": "products", "label": "Shop Products" },
            { "value": "custom", "label": "Shop Custom" }
          ],
          "default": "products"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Section Title",
          "info": "e.g. 'Shop Sofa By:'"
        },
        {
          "type": "link_list",
          "id": "menu",
          "label": "Select Menu"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Custom Mega Menu"
    }
  ]
}
{% endschema %}

{%- liquid
  capture icon_search
    render 'icon-search', style_icon: 'classic'
  endcapture
  capture icon_cart
    render 'icon-cart', style_icon: 'classic'
  endcapture
  capture icon_wishlist
    render 'icon-wishlist', style_icon: 'classic'
  endcapture
  capture icon_account
    render 'icon-account', style_icon: 'classic'
  endcapture
-%}

<style>
  /* Base Reset */
  .cmm-container * { box-sizing: border-box; }
  .cmm-container {
    width: 100%;
    background: #fff;
    font-family: 'DM Sans', var(--font-body-family, sans-serif); 
    color: #000;
    position: relative;
    z-index: 1000;
    transition: transform var(--duration-default) ease;
  }
  
  .cmm-container.is-sticky {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1001;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  }

  .cmm-container.sticky-hidden {
    transform: translateY(-100%);
  }

  /* Prevent background scroll when mega menu is open */
  body.mega-menu-open {
    overflow: hidden !important;
    height: 100vh;
  }

  /* Header Bar */
  .cmm-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 70px;
    height: 80px;
    background: #fff;
    position: relative;
    z-index: 20;
  }

  .cmm-header-left, .cmm-header-right {
    display: flex;
    align-items: center;
    gap: 15px;
    flex: 1;
  }
  .cmm-header-right { justify-content: flex-end; }

  .cmm-tabs { display: flex; gap: 40px; height: 100%; }
  .cmm-tab {
    display: flex;
    align-items: center;
    height: 100%;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    color: #000;
    letter-spacing: 0.5px;
  }
  .cmm-tab.active, .cmm-tab:hover {
    font-weight: 700;
    border-bottom-color: #000;
  }

  .cmm-logo { position: absolute; left: 50%; transform: translateX(-50%); }
  .cmm-logo img { display: block; width: {{ section.settings.logo_width }}px; height: auto; }

  .cmm-icons.header__icons { display: flex; gap: 10px; align-items: center; }
  .cmm-icons .header__icon, .cmm-header-left .header__icon, .cmm-hamburger .cmm-icon-btn {
    width: 44px; height: 44px;
    display: flex; align-items: center; justify-content: center;
    color: #000; position: relative;
    background: none; border: none; padding: 0; cursor: pointer;
  }
  .cmm-header svg { width: 2rem; height: 2rem; }
  
  /* Desktop Visibility */
  .cmm-header-search-mobile { display: none; }
  .cmm-header-search-desktop { display: flex; }
  .cmm-hamburger { display: none; }

  @media(min-width: 991px) {
    .cmm-header-right .header__icon { display: flex !important; }
  }

  @media(max-width: 990px) {
      .cmm-header { padding: 0 15px; height: 60px; }
      .cmm-header-left, .cmm-header-right { gap: 5px; }
      .cmm-tabs { display: none !important; }
      .cmm-hamburger { display: flex; margin-right: 5px; }
      .cmm-header-search-mobile { display: flex; }
      .cmm-header-search-desktop { display: none; }
      .cmm-header-right .header__icon { display: flex !important; }
      .cmm-logo img { width: 100px; } /* Adjust mobile logo size if needed */
  }
  
  .cmm-cart-count {
      position: absolute; top: -5px; right: -8px;
      background: #000; color: #fff;
      font-size: 10px; font-weight: 700;
      width: 16px; height: 16px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
  }
  
  /* Hamburger (Mobile) */
  .cmm-hamburger { display: none; margin-right: 0px; }

  /* Mega Dropdown */
  .cmm-dropdown-wrapper {
    position: absolute;
    top: 80px; 
    left: 0%; 
    width: fit-content;
    border-top: 1px solid #f0f0f0;
    opacity: 0;
    visibility: hidden;
    height:fit-content;
    z-index: 15;
    box-shadow: 0 10px 40px rgba(0,0,0,0.05);
    transition: opacity 0.3s ease, visibility 0.3s ease, height 0s linear 0.3s;
    overflow: hidden;
    border-radius: 0 0 8px 8px; /* Optional slight round */
  }
  .cmm-dropdown-wrapper.open {
    opacity: 1; 
    visibility: visible; 
    height: fit-content;
    transition: opacity 0.3s ease, visibility 0.3s ease, height 0s linear 0s;
  }

  .cmm-grid {
    display: flex;
    height: fit-content;
    width:fit-content;
  }

  /* SIDEBAR */
  .cmm-sidebar {
    width: 400px;
    flex-shrink: 0;
    padding: 30px 0 30px 50px;
    overflow-y: auto;
    /* Custom Scrollbar for sleekness */
    scrollbar-width: thin;
    scrollbar-color: #e0e0e0 #f7f7f7;
    background-color: #ffffffff; /* Light Grey Sidebar */
    height:100vh;
  }
  .cmm-sidebar::-webkit-scrollbar { width: 4px; }
  .cmm-sidebar::-webkit-scrollbar-thumb { background: #e0e0e0; }

  .cmm-group-title {
    font-size: 13px; font-weight: 700; text-transform: capitalize;
    color: #565656; margin: 20px 0 8px 0; display: block;
    line-height: 1.4;
  }
  .cmm-group-title:first-child { margin-top: 0; }

  .cmm-sidebar-link {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 15px 8px 10px;
    font-size: 14px;
    color: #444;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    font-weight: 500;
    border-radius: 4px;
    margin-bottom: 2px;
    opacity: 0; /* Hidden initially */
  }
  
  /* Only animate when parent is open */
  .cmm-dropdown-wrapper.open .cmm-sidebar-link {
    animation: slideInLeft 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  /* Stagger delays via nth-child roughly or just common anim */
  .cmm-dropdown-wrapper.open .cmm-sidebar-link:nth-child(1) { animation-delay: 0.05s; }
  .cmm-dropdown-wrapper.open .cmm-sidebar-link:nth-child(2) { animation-delay: 0.1s; }
  .cmm-dropdown-wrapper.open .cmm-sidebar-link:nth-child(3) { animation-delay: 0.15s; }
  .cmm-dropdown-wrapper.open .cmm-sidebar-link:nth-child(4) { animation-delay: 0.2s; }
  .cmm-dropdown-wrapper.open .cmm-sidebar-link:nth-child(5) { animation-delay: 0.25s; }
  .cmm-dropdown-wrapper.open .cmm-sidebar-link:nth-child(6) { animation-delay: 0.3s; }
  .cmm-dropdown-wrapper.open .cmm-sidebar-link:nth-child(7) { animation-delay: 0.35s; }
  .cmm-dropdown-wrapper.open .cmm-sidebar-link:nth-child(8) { animation-delay: 0.4s; }
  .cmm-dropdown-wrapper.open .cmm-sidebar-link:nth-child(n+9) { animation-delay: 0.45s; }

  .cmm-sidebar-link:hover, .cmm-sidebar-link.active {
    color: #565656;
    background: #EAE6E3; /* White Active Item */
    font-weight: 700;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }

  /* SUBMENU */
  .cmm-col-middle {
    width: 300px;
    flex-shrink: 0;
    padding: 40px 0 40px 40px;
    overflow-y: auto;
    display: none; /* Hide by default */
  }
  .cmm-col-middle.active {
    display: block;
    animation: fadeInPanel 0.4s ease forwards;
    background-color: white;
    height: fit-content;
  }
  .cmm-submenu-panel {
    display: none;
    animation: fadeInPanel 0.4s ease forwards;
  }
  .cmm-submenu-panel.active { display: block; }

  @keyframes slideInLeft {
    from { opacity: 0; transform: translateX(-10px); }
    to { opacity: 1; transform: translateX(0); }
  }
  @keyframes fadeInPanel {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .cmm-sub-heading {
    font-size: 14px; font-weight: 700; margin-bottom: 15px; 
    text-transform: capitalize; color: #000; display: block;
  }
  .cmm-sub-list { list-style: none; padding: 0; margin: 0; }
  .cmm-sub-list li { margin-bottom: 10px; }
  .cmm-sub-list a {
    text-decoration: none; color: #555; font-size: 14px; transition: color 0.2s; padding:8px 15px 8px 10px
  }
  .cmm-sub-list a:hover { color: #000; text-decoration: none; background:#EAE6E3; box-shadow: 0 2px 5px rgba(0,0,0,0.05); width:inherit ;  }

  /* PROMO */
  .cmm-promo-panel {
    flex: 1;
    display: none;
    position: relative;
    overflow: hidden;
  }
  .cmm-promo-panel.active { display: block; }
  
  .cmm-promo-empty {
    width: 100%;
    height: 100%;
  }
  .cmm-promo-img { width: 100%; height: 100%; object-fit: cover; }
  .cmm-promo-content {
      position: absolute; bottom: 40px; left: 40px; color: #fff; z-index: 2;
  }

  /* BACKDROP */
  .cmm-backdrop {
    position: fixed; top: 80px; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.5); z-index: 10;
    opacity: 0; visibility: hidden; transition: 0.3s;
  }
  .cmm-backdrop.active { opacity: 1; visibility: visible; }
  
  /* MOBILE DRAWER ENHANCEMENTS (header.liquid parity) */
  .cmm-mobile-drawer {
      height: 100vh; width: 85%; max-width: 400px;
      position: fixed; top: 0; left: 0;
      background: #fff; z-index: 101;
      transform: translateX(-100%);
      transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
      overflow: hidden; /* Hide panels that slide out */
  }
  .cmm-mobile-drawer.open { transform: translateX(0); }
  
  .cmm-m-view {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      background: #fff;
      display: flex; flex-direction: column;
      transition: transform 0.3s ease;
      transform: translateX(100%);
  }
  .cmm-m-view.active { transform: translateX(0); }
  .cmm-m-view.exit-left { transform: translateX(-100%); }

  .cmm-m-header {
      padding: 15px 20px;
      display: flex; align-items: center;
      border-bottom: 1px solid #eee;
      font-weight: bold; font-size: 16px;
      min-height: 56px;
  }
  .cmm-m-back {
      background: none; border: none; padding: 0; margin-right: 15px;
      display: flex; align-items: center; cursor: pointer;
  }
  .cmm-m-back svg { width: 14px; height: 14px; margin-right: 5px; transform: rotate(180deg); } /* theme arrow fix */
  
  .cmm-m-list { list-style: none; padding: 0; margin: 0; flex: 1; overflow-y: auto; }
  .cmm-m-item { border-bottom: 1px solid #f5f5f5; }
  .cmm-m-link {
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px 20px; text-decoration: none; color: #000;
      font-size: 14px; cursor: pointer; border: none; width: 100%; background: none; text-align: left;
  }
  .cmm-m-link:hover { background: #fafafa; }
  
  .cmm-m-caret { 
      width: 12px; height: 12px; opacity: 0.5; 
      display: inline-block;
      transform: rotate(-90deg); 
  }

  /* Submenu links (Level 3) */
  .cmm-m-sub-link {
      display: block; padding: 12px 20px; font-size: 14px; color: #555; text-decoration: none;
      border-bottom: 1px solid #f9f9f9;
  }
  .cmm-m-goto { font-weight: bold; border-bottom: 1px solid #eee; background: #fafafa; }

  /* MOBILE DRAWER STYLES */
  .cmm-mobile-overlay {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.5); z-index: 1;
      display: none;
  }
  .cmm-mobile-overlay.active { display: block; }
  
  .cmm-m-close { background:none; border:none; font-size: 24px; cursor: pointer; }
  
  /* MEDIA QUERIES */
  @media(max-width: 990px) {
    .cmm-header { padding: 0 20px; height: 60px; }
    .cmm-tabs { display: none; }
    .cmm-dropdown-wrapper { display: none !important; } /* Hide Desktop Mega Menu */
    .cmm-sidebar { display: none !important; }
    .cmm-hamburger { display: block; }
    .cmm-logo img { width: 100px; }
    .cmm-container { display: block; } /* Show Container (Header) */
    .cmm-backdrop { display: none; }
  }
</style>

{% if section.settings.show_mega_menu %}
<div class="cmm-container" id="cmm-wrapper">
  
  <!-- MOBILE DRAWER HTML -->
  <div class="cmm-mobile-overlay" id="cmm-m-overlay"></div>
  <div class="cmm-mobile-drawer" id="cmm-m-drawer">
      
      <!-- LEVEL 1: Main Menu -->
      <div class="cmm-m-view active" id="view-main">
          <div class="cmm-m-header">
              <span>Menu</span>
              <button class="cmm-m-close" id="cmm-m-close" style="margin-left: auto; background:none; border:none; font-size:24px;">&times;</button>
          </div>
          <ul class="cmm-m-list">
              <li class="cmm-m-item">
                  <div class="cmm-m-link" onclick="openMobileLevel('view-products')">
                      Shop Products 
                      <span class="cmm-m-caret">{% render 'icon-caret' %}</span>
                  </div>
              </li>
              <li class="cmm-m-item">
                  <div class="cmm-m-link" onclick="openMobileLevel('view-custom')">
                      Shop Custom 
                      <span class="cmm-m-caret">{% render 'icon-caret' %}</span>
                  </div>
              </li>
          </ul>
      </div>

      <!-- LEVEL 2: Products -->
      <div class="cmm-m-view" id="view-products">
          <div class="cmm-m-header">
              <button class="cmm-m-back" onclick="closeMobileLevel()">
                  {% render 'icon-arrow' %}
              </button>
              {% assign mobile_products = section.settings.mobile_menu_products | default: section.settings.menu_products %}
              {% if mobile_products != blank %}
                  <li class="cmm-m-item">
                      <a href="{{ linklists[mobile_products].url }}" class="cmm-m-sub-link cmm-m-goto">Go to Shop Products</a>
                  </li>
                  {% for link in linklists[mobile_products].links %}
                      <li class="cmm-m-item">
                          {% if link.links != blank %}
                              <div class="cmm-m-link" onclick="openMobileLevel('view-{{ link.handle }}')">
                                  {{ link.title }} <span class="cmm-m-caret">{% render 'icon-caret' %}</span>
                              </div>
                          {% else %}
                              <a href="{{ link.url }}" class="cmm-m-sub-link">{{ link.title }}</a>
                          {% endif %}
                      </li>
                  {% endfor %}
              {% else %}
                  <!-- Hardcoded Products Sub-levels -->
                  <li class="cmm-m-item"><div class="cmm-m-link" onclick="openMobileLevel('view-sofas')">Sofas <span class="cmm-m-caret">{% render 'icon-caret' %}</span></div></li>
                  <li class="cmm-m-item"><div class="cmm-m-link" onclick="openMobileLevel('view-beds')">Beds <span class="cmm-m-caret">{% render 'icon-caret' %}</span></div></li>
                  <li class="cmm-m-item"><div class="cmm-m-link" onclick="openMobileLevel('view-acc')">Accessories <span class="cmm-m-caret">{% render 'icon-caret' %}</span></div></li>
                  <li class="cmm-m-item"><a href="#" class="cmm-m-sub-link">Next Day Delivery</a></li>
                  <li class="cmm-m-item"><a href="#" class="cmm-m-sub-link">Clearance</a></li>
              {% endif %}

              {% for block in section.blocks %}
                {% if block.type == 'sidebar_section' and block.settings.tab == 'products' %}
                    {% if block.settings.title != blank %}
                        <li class="cmm-m-item cmm-m-header" style="background:#f9f9f9; min-height:40px; border-bottom:1px solid #eee; display:flex; align-items:center; padding: 0 20px;"><span>{{ block.settings.title }}</span></li>
                    {% endif %}
                    {% if block.settings.menu != blank %}
                        {% for link in linklists[block.settings.menu].links %}
                            <li class="cmm-m-item">
                                {% if link.links != blank %}
                                    <div class="cmm-m-link" onclick="openMobileLevel('m-view-{{ link.title | handle }}')">
                                        {{ link.title }} <span class="cmm-m-caret">{% render 'icon-caret' %}</span>
                                    </div>
                                {% else %}
                                    <a href="{{ link.url }}" class="cmm-m-sub-link">{{ link.title }}</a>
                                {% endif %}
                            </li>
                        {% endfor %}
                    {% endif %}
                {% endif %}
              {% endfor %}
          </ul>
      </div>

      <!-- LEVEL 2: Custom -->
      <div class="cmm-m-view" id="view-custom">
          <div class="cmm-m-header">
              <button class="cmm-m-back" onclick="closeMobileLevel()">
                  {% render 'icon-arrow' %}
              </button>
              <span>Shop Custom</span>
          </div>
          <ul class="cmm-m-list">
              {% assign mobile_custom = section.settings.mobile_menu_custom | default: section.settings.menu_custom %}
              {% if mobile_custom != blank %}
                   <li class="cmm-m-item">
                      <a href="{{ linklists[mobile_custom].url }}" class="cmm-m-sub-link cmm-m-goto">Go to Shop Custom</a>
                  </li>
                   {% for link in linklists[mobile_custom].links %}
                      <li class="cmm-m-item">
                          <a href="{{ link.url }}" class="cmm-m-sub-link">{{ link.title }}</a>
                      </li>
                  {% endfor %}
              {% else %}
                  <li class="cmm-m-item"><div class="cmm-m-link" onclick="openMobileLevel('view-cust-sofas')">Custom Sofas <span class="cmm-m-caret">{% render 'icon-caret' %}</span></div></li>
                  <li class="cmm-m-item"><a href="#" class="cmm-m-sub-link">Custom Beds</a></li>
                  <li class="cmm-m-item"><a href="#" class="cmm-m-sub-link">Instant Estimate</a></li>
              {% endif %}

              {% for block in section.blocks %}
                {% if block.type == 'sidebar_section' and block.settings.tab == 'custom' %}
                    {% if block.settings.title != blank %}
                        <li class="cmm-m-item cmm-m-header" style="background:#f9f9f9; min-height:40px; border-bottom:1px solid #eee; display:flex; align-items:center; padding: 0 20px;"><span>{{ block.settings.title }}</span></li>
                    {% endif %}
                    {% if block.settings.menu != blank %}
                        {% for link in linklists[block.settings.menu].links %}
                            <li class="cmm-m-item">
                                {% if link.links != blank %}
                                    <div class="cmm-m-link" onclick="openMobileLevel('m-view-{{ link.title | handle }}')">
                                        {{ link.title }} <span class="cmm-m-caret">{% render 'icon-caret' %}</span>
                                    </div>
                                {% else %}
                                    <a href="{{ link.url }}" class="cmm-m-sub-link">{{ link.title }}</a>
                                {% endif %}
                            </li>
                        {% endfor %}
                    {% endif %}
                {% endif %}
              {% endfor %}
          </ul>
      </div>

      <!-- LEVEL 3: HARDCODED SUB-VIEWS -->
      <div class="cmm-m-view" id="view-sofas">
          <div class="cmm-m-header"> <button class="cmm-m-back" onclick="closeMobileLevel()">{% render 'icon-arrow' %}</button> <span>Sofas</span> </div>
          <ul class="cmm-m-list">
              <li><a href="#" class="cmm-m-sub-link cmm-m-goto">Go to Sofas</a></li>
              <li><a href="#" class="cmm-m-sub-link">Corner Sofas</a></li>
              <li><a href="#" class="cmm-m-sub-link">Sofa Beds</a></li>
              <li><a href="#" class="cmm-m-sub-link">Recliner Sofas</a></li>
          </ul>
      </div>
       <div class="cmm-m-view" id="view-beds">
          <div class="cmm-m-header"> <button class="cmm-m-back" onclick="closeMobileLevel()">{% render 'icon-arrow' %}</button> <span>Beds</span> </div>
          <ul class="cmm-m-list">
            <li><a href="#" class="cmm-m-sub-link cmm-m-goto">Go to Beds</a></li>
            <li><a href="#" class="cmm-m-sub-link">Storage Beds</a></li>
            <li><a href="#" class="cmm-m-sub-link">Divan Beds</a></li>
          </ul>
      </div>
       <div class="cmm-m-view" id="view-acc">
          <div class="cmm-m-header"> <button class="cmm-m-back" onclick="closeMobileLevel()">{% render 'icon-arrow' %}</button> <span>Accessories</span> </div>
          <ul class="cmm-m-list">
            <li><a href="#" class="cmm-m-sub-link cmm-m-goto">Go to Accessories</a></li>
            <li><a href="#" class="cmm-m-sub-link">Dining Tables</a></li>
            <li><a href="#" class="cmm-m-sub-link">Rugs</a></li>
          </ul>
      </div>
      <div class="cmm-m-view" id="view-cust-sofas">
          <div class="cmm-m-header"> <button class="cmm-m-back" onclick="closeMobileLevel()">{% render 'icon-arrow' %}</button> <span>Custom Sofas</span> </div>
          <ul class="cmm-m-list">
            <li><a href="#" class="cmm-m-sub-link cmm-m-goto">Go to Custom Sofas</a></li>
            <li><a href="#" class="cmm-m-sub-link">Customisable Sofas</a></li>
            <li><a href="#" class="cmm-m-sub-link">Custom Sofa Journey</a></li>
          </ul>
      </div>

       <!-- DYNAMIC LEVEL 3: Generate automatically for dynamic menus -->
        {% if mobile_products != blank %}
             {% for link in linklists[mobile_products].links %}
                  {% if link.links != blank %}
                     <div class="cmm-m-view" id="view-{{ link.handle }}">
                         <div class="cmm-m-header"> <button class="cmm-m-back" onclick="closeMobileLevel()">{% render 'icon-arrow' %}</button> <span>{{ link.title }}</span> </div>
                         <ul class="cmm-m-list">
                             <li><a href="{{ link.url }}" class="cmm-m-sub-link cmm-m-goto">Go to {{ link.title }}</a></li>
                             {% for child in link.links %}
                                 <li><a href="{{ child.url }}" class="cmm-m-sub-link">{{ child.title }}</a></li>
                             {% endfor %}
                         </ul>
                     </div>
                  {% endif %}
             {% endfor %}
        {% endif %}

        <!-- SECTION-DRIVEN LEVEL 3: Sidebar Blocks -->
        {% for block in section.blocks %}
             {% if block.type == 'sidebar_section' and block.settings.menu != blank %}
                 {% for link in linklists[block.settings.menu].links %}
                     {% if link.links != blank %}
                         <div class="cmm-m-view" id="m-view-{{ link.title | handle }}">
                             <div class="cmm-m-header"> <button class="cmm-m-back" onclick="closeMobileLevel()">{% render 'icon-arrow' %}</button> <span>{{ link.title }}</span> </div>
                             <ul class="cmm-m-list">
                                 <li><a href="{{ link.url }}" class="cmm-m-sub-link cmm-m-goto">Go to {{ link.title }}</a></li>
                                 {% for child in link.links %}
                                     <li><a href="{{ child.url }}" class="cmm-m-sub-link">{{ child.title }}</a></li>
                                 {% endfor %}
                             </ul>
                         </div>
                     {% endif %}
                 {% endfor %}
             {% endif %}
        {% endfor %}

  </div>

  <div class="cmm-header">
    <div class="cmm-header-left">
        <div class="cmm-hamburger">
            <button class="cmm-icon-btn" id="cmm-m-open">{% render 'icon-hamburger' %}</button>
        </div>
        
        <div class="cmm-header-search-mobile">
            <side-drawer-opener class="header__icon header__icon--search d-flex j-c-center a-i-center p-0 u-none color-foreground f-a-none" data-side-drawer="#Drawer-Search">
              <button class="t-button b-none c-pointer p-0 color-foreground bg-transparent focus-inset no-js-hidden" type="button" aria-haspopup="dialog" aria-label="{{ 'general.search.search' | t }}">
                {{ icon_search }}
              </button>
            </side-drawer-opener>
        </div>

        <div class="cmm-tabs">
          <div class="cmm-tab" data-target="products">Shop Products</div>
          <div class="cmm-tab" data-target="custom">Shop Custom</div>
        </div>
    </div>
    
    <div class="cmm-logo">
      <a href="{{ routes.root_url }}">
        {% if section.settings.logo %}
           <img src="{{ section.settings.logo | image_url: width: section.settings.logo_width }}" alt="{{ shop.name }}">
        {% else %}
           <h3>{{ shop.name }}</h3>
        {% endif %}
      </a>
    </div>
    
    <div class="cmm-header-right cmm-icons header__icons">
        <div class="cmm-header-search-desktop">
            <side-drawer-opener class="header__icon header__icon--search d-flex j-c-center a-i-center p-0 u-none color-foreground f-a-none" data-side-drawer="#Drawer-Search">
              <button class="t-button b-none c-pointer p-0 color-foreground bg-transparent focus-inset no-js-hidden" type="button" aria-haspopup="dialog" aria-label="{{ 'general.search.search' | t }}">
                {{ icon_search }}
              </button>
            </side-drawer-opener>
        </div>

        <a href="{%- if customer -%}{{ routes.account_url }}{%- else -%}{{ routes.account_login_url }}{%- endif -%}" class="header__icon header__icon--account d-flex j-c-center a-i-center p-0 u-none color-foreground f-a-none">
            {{ icon_account }}
        </a>

        <side-drawer-opener class="header__icon header__icon--cart d-flex j-c-center a-i-center p-0 pos-relative u-none color-foreground f-a-none" data-side-drawer="#Cart-Drawer">
          <button class="t-button b-none c-pointer p-0 color-foreground bg-transparent focus-inset no-js-hidden" 
            type="button" 
            aria-haspopup="dialog" 
            aria-label="{{ 'templates.cart.cart_items' | t: count: cart.item_count }}"
          >
            {{ icon_cart }}
            {%- if cart.item_count < 100 -%}
              <div class="cart-count-bubble l-h-1 pos-absolute b-circle d-flex j-c-center a-i-center cart-icon-bubble">
                <span aria-hidden="true">{{ cart.item_count }}</span>
                <span class="visually-hidden">{{ 'sections.header.cart_count' | t: count: cart.item_count }}</span>
              </div>
            {%- endif -%}
          </button>
        </side-drawer-opener>
    </div>
  </div>
  
  <div class="cmm-backdrop"></div>

  <!-- TAB: SHOP PRODUCTS -->
  <div class="cmm-dropdown-wrapper" id="dropdown-products">
    <div class="cmm-grid">
        <!-- 1. Left Sidebar -->
        <div class="cmm-sidebar">
            {% if section.settings.menu_products != blank %}
                {% for link in linklists[section.settings.menu_products].links %}
                    <div class="cmm-sidebar-link" data-handle="{{ link.title | handle }}">
                        {{ link.title }} {% if link.links != blank %}<span>&#10095;</span>{% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <div class="cmm-sidebar-link" data-handle="sofas">Sofas <span>&#10095;</span></div>
                <div class="cmm-sidebar-link" data-handle="beds">Beds <span>&#10095;</span></div>
                <div class="cmm-sidebar-link" data-handle="accessories">Accessories <span>&#10095;</span></div>
                <div class="cmm-sidebar-link" data-handle="next-day">Next Day Delivery</div>
                <div class="cmm-sidebar-link" data-handle="clearance">clearance</div>
                
                <span class="cmm-group-title">Shop Sofa By:</span>
                <div class="cmm-sidebar-link" data-handle="type">Type <span>&#10095;</span></div>
                <div class="cmm-sidebar-link" data-handle="filling">Filling <span>&#10095;</span></div>

                <span class="cmm-group-title">Shop Accessories By:</span>
                <div class="cmm-sidebar-link" data-handle="acc-type">Type <span>&#10095;</span></div>
                <div class="cmm-sidebar-link" data-handle="material">Material <span>&#10095;</span></div>

                <span class="cmm-group-title">Shop By Delivery:</span>
                <div class="cmm-sidebar-link" data-handle="instock">In stock, Delivered Tomorrow</div>
                <div class="cmm-sidebar-link" data-handle="custom-del">Custom, Delivered In 14 Days</div>
                
                <span class="cmm-group-title">Shop By Collection:</span>
                <div class="cmm-sidebar-link" data-handle="coll-custom">Completely Customisable</div>
                <div class="cmm-sidebar-link" data-handle="coll-fabric">Customisable Fabric</div>
                <div class="cmm-sidebar-link" data-handle="new">New Arrivals</div>
                <div class="cmm-sidebar-link" data-handle="best">Best Sellers</div>
                <div class="cmm-sidebar-link" data-handle="feather">The Feather Cloud Collection</div>
            {% endif %}

            {% for block in section.blocks %}
              {% if block.type == 'sidebar_section' and block.settings.tab == 'products' %}
                {% if block.settings.title != blank %}
                  <span class="cmm-group-title">{{ block.settings.title }}</span>
                {% endif %}
                {% if block.settings.menu != blank %}
                  {% for link in linklists[block.settings.menu].links %}
                    <div class="cmm-sidebar-link" data-handle="{{ link.title | handle }}">
                        {{ link.title }} {% if link.links != blank %}<span>&#10095;</span>{% endif %}
                    </div>
                  {% endfor %}
                {% endif %}
              {% endif %}
            {% endfor %}
        </div>

        <!-- 2. Middle Panel -->
        <div class="cmm-col-middle">
            {% if section.settings.menu_products != blank %}
                 {% for link in linklists[section.settings.menu_products].links %}
                    {% if link.links != blank %}
                        <div class="cmm-submenu-panel" id="panel-{{ link.title | handle }}">
                            <span class="cmm-sub-heading">{{ link.title }}</span>
                            <ul class="cmm-sub-list">
                                {% for child in link.links %}
                                    <li><a href="{{ child.url }}">{{ child.title }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                 {% endfor %}
            {% else %}
                <!-- Hardcoded Content Panels -->
                
                <!-- Sofas -->
                <div class="cmm-submenu-panel" id="panel-sofas">
                    <span class="cmm-sub-heading">Sofas</span>
                    <ul class="cmm-sub-list">
                        <li><a href="#">All Sofas</a></li>
                        <li><a href="#">Customisable Sofas</a></li>
                        <li><a href="#">Corner Sofas</a></li>
                        <li><a href="#">Modular Sofas</a></li>
                        <li><a href="#">Sofa Beds</a></li>
                        <li><a href="#">Recliner Sofas</a></li>
                        <li><a href="#">Curved Sofas</a></li>
                        <li><a href="#">4 Seater Sofas</a></li>
                        <li><a href="#">3 Seater Sofas</a></li>
                        <li><a href="#">2 Seater Sofas</a></li>
                        <li><a href="#">Armchairs</a></li>
                        <li><a href="#">Accent Chairs</a></li>
                        <li><a href="#">Ottoman Footstool</a></li>
                    </ul>
                </div>
                
                <!-- Beds -->
                <div class="cmm-submenu-panel" id="panel-beds">
                    <span class="cmm-sub-heading">Beds</span>
                    <ul class="cmm-sub-list">
                        <li><a href="#">All Beds</a></li>
                        <li><a href="#">Storage Beds</a></li>
                        <li><a href="#">Divan Beds</a></li>
                        <li><a href="#">Bed Frames</a></li>
                    </ul>
                </div>

                <!-- Accessories -->
                <div class="cmm-submenu-panel" id="panel-accessories">
                    <span class="cmm-sub-heading">Accessories</span>
                    <ul class="cmm-sub-list">
                        <li><a href="#">All Accessories</a></li>
                        <li><a href="#">Dining Tables</a></li>
                        <li><a href="#">Coffee Tables</a></li>
                        <li><a href="#">Side Tables</a></li>
                        <li><a href="#">Rugs</a></li>
                        <li><a href="#">Mirrors</a></li>
                    </ul>
                </div>
                
                <!-- Generic Fallback for others to prevent empty space -->
                 <div class="cmm-submenu-panel" id="panel-type">
                    <span class="cmm-sub-heading">Type</span>
                    <ul class="cmm-sub-list">
                        <li><a href="#">Corner Sofas</a></li>
                        <li><a href="#">Recliners</a></li>
                    </ul>
                </div>
            {% endif %}

            {% for block in section.blocks %}
              {% if block.type == 'sidebar_section' and block.settings.tab == 'products' %}
                {% if block.settings.menu != blank %}
                  {% for link in linklists[block.settings.menu].links %}
                    {% if link.links != blank %}
                      <div class="cmm-submenu-panel" id="panel-{{ link.title | handle }}">
                          <span class="cmm-sub-heading">{{ link.title }}</span>
                          <ul class="cmm-sub-list">
                              {% for child in link.links %}
                                  <li><a href="{{ child.url }}">{{ child.title }}</a></li>
                              {% endfor %}
                          </ul>
                      </div>
                    {% endif %}
                  {% endfor %}
                {% endif %}
              {% endif %}
            {% endfor %}
        </div>

        <!-- 3. Right Promo -->
        <div class="cmm-promo-panel active">
             <!-- Dynamic Block Injection Here via JS logic if block exists -->
             <div class="cmm-promo-empty"></div>
        </div>
    </div>
  </div>


  <!-- TAB: SHOP CUSTOM -->
  <div class="cmm-dropdown-wrapper" id="dropdown-custom">
    <div class="cmm-grid">
         <!-- Sidebar -->
         <div class="cmm-sidebar">
            {% if section.settings.menu_custom != blank %}
                {% for link in linklists[section.settings.menu_custom].links %}
                    <div class="cmm-sidebar-link" data-handle="{{ link.title | handle }}">
                        {{ link.title }} {% if link.links != blank %}<span>&#10095;</span>{% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <div class="cmm-sidebar-link" data-handle="custom-sofas">Custom Sofas <span>&#10095;</span></div>
                <div class="cmm-sidebar-link" data-handle="custom-beds">Custom Beds <span>&#10095;</span></div>
                <div class="cmm-sidebar-link" data-handle="instant">Instant Estimate <span>&#10095;</span></div>
                <div class="cmm-sidebar-link" data-handle="swatches">Free Fabric Swatches</div>
                <div class="cmm-sidebar-link" data-handle="inspiration">Send Your Inspiration</div>
                <span class="cmm-group-title">Info</span>
                <div class="cmm-sidebar-link" data-handle="about">About Us</div>
                <div class="cmm-sidebar-link" data-handle="tabby">Tabby Pay In Four</div>
                <div class="cmm-sidebar-link" data-handle="tamara">Tamara Pay In Three</div>
                <div class="cmm-sidebar-link" data-handle="delivery">Delivery</div>
                <div class="cmm-sidebar-link" data-handle="returns">Returns Policy</div>
                <div class="cmm-sidebar-link" data-handle="contact">Contact Us</div>
            {% endif %}

            {% for block in section.blocks %}
              {% if block.type == 'sidebar_section' and block.settings.tab == 'custom' %}
                {% if block.settings.title != blank %}
                  <span class="cmm-group-title">{{ block.settings.title }}</span>
                {% endif %}
                {% if block.settings.menu != blank %}
                  {% for link in linklists[block.settings.menu].links %}
                    <div class="cmm-sidebar-link" data-handle="{{ link.title | handle }}">
                        {{ link.title }} {% if link.links != blank %}<span>&#10095;</span>{% endif %}
                    </div>
                  {% endfor %}
                {% endif %}
              {% endif %}
            {% endfor %}
         </div>

         <!-- Panel -->
         <div class="cmm-col-middle">
            {% if section.settings.menu_custom != blank %}
                 {% for link in linklists[section.settings.menu_custom].links %}
                    {% if link.links != blank %}
                        <div class="cmm-submenu-panel" id="panel-{{ link.title | handle }}">
                            <span class="cmm-sub-heading">{{ link.title }}</span>
                             <ul class="cmm-sub-list">
                                {% for child in link.links %}
                                    <li><a href="{{ child.url }}">{{ child.title }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                 {% endfor %}
            {% else %}
                <div class="cmm-submenu-panel" id="panel-custom-sofas">
                    <span class="cmm-sub-heading">Custom Sofas</span>
                    <ul class="cmm-sub-list">
                        <li><a href="#">Customisable Sofas</a></li>
                        <li><a href="#">Custom Sofa Journey</a></li>
                        <li><a href="#">Custom Sofa Estimator</a></li>
                    </ul>
                </div>
                 <div class="cmm-submenu-panel" id="panel-custom-beds">
                    <span class="cmm-sub-heading">Custom Beds</span>
                    <ul class="cmm-sub-list">
                        <li><a href="#">Customisable Beds</a></li>
                        <li><a href="#">Custom Bed Journey</a></li>
                        <li><a href="#">Custom Bed Estimator</a></li>
                    </ul>
                </div>
            {% endif %}

            {% for block in section.blocks %}
              {% if block.type == 'sidebar_section' and block.settings.tab == 'custom' %}
                {% if block.settings.menu != blank %}
                  {% for link in linklists[block.settings.menu].links %}
                    {% if link.links != blank %}
                      <div class="cmm-submenu-panel" id="panel-{{ link.title | handle }}">
                          <span class="cmm-sub-heading">{{ link.title }}</span>
                          <ul class="cmm-sub-list">
                              {% for child in link.links %}
                                  <li><a href="{{ child.url }}">{{ child.title }}</a></li>
                              {% endfor %}
                          </ul>
                      </div>
                    {% endif %}
                  {% endfor %}
                {% endif %}
              {% endif %}
            {% endfor %}
         </div>
         
         <div class="cmm-promo-panel active"><div class="cmm-promo-empty"></div></div>
    </div>
  </div>

</div>


<script>
// Mobile Navigation Logic (header.liquid parity)
let mStack = ['view-main'];

window.openMobileLevel = function(id) {
    const nextView = document.getElementById(id);
    const currView = document.getElementById(mStack[mStack.length - 1]);
    
    if(nextView && currView) {
        currView.classList.remove('active');
        currView.classList.add('exit-left');
        nextView.classList.add('active');
        mStack.push(id);
    }
}

window.closeMobileLevel = function() {
    if(mStack.length <= 1) return;
    
    const currId = mStack.pop();
    const prevId = mStack[mStack.length - 1];
    
    const currView = document.getElementById(currId);
    const prevView = document.getElementById(prevId);
    
    if(currView && prevView) {
        currView.classList.remove('active');
        prevView.classList.remove('exit-left');
        prevView.classList.add('active');
    }
}

// Reset levels when closed
function resetMobileDrawer() {
    mStack.forEach(id => {
        const el = document.getElementById(id);
        if(el) {
            el.classList.remove('active', 'exit-left');
        }
    });
    const main = document.getElementById('view-main');
    if(main) main.classList.add('active');
    mStack = ['view-main'];
}

document.addEventListener('DOMContentLoaded', () => {
    const root = document.getElementById('cmm-wrapper');
    if(!root) return;

    const tabs = root.querySelectorAll('.cmm-tab');
    const dropdowns = {
        'products': root.querySelector('#dropdown-products'),
        'custom': root.querySelector('#dropdown-custom')
    };
    const backdrop = root.querySelector('.cmm-backdrop');
    
    // Mobile Elements
    const mOpen = document.getElementById('cmm-m-open');
    const mClose = document.getElementById('cmm-m-close');
    const mDrawer = document.getElementById('cmm-m-drawer');
    const mOverlay = document.getElementById('cmm-m-overlay');
    
    if(mOpen) {
        mOpen.addEventListener('click', () => {
            mDrawer.classList.add('open');
            mOverlay.classList.add('active');
        });
    }
    if(mClose) {
        mClose.addEventListener('click', () => {
            mDrawer.classList.remove('open');
            mOverlay.classList.remove('active');
            setTimeout(resetMobileDrawer, 300);
        });
    }
    if(mOverlay) {
        mOverlay.addEventListener('click', () => {
            mDrawer.classList.remove('open');
            mOverlay.classList.remove('active');
            setTimeout(resetMobileDrawer, 300);
        });
    }

    // Function: Activate a Tab
    function openDropdown(id) {
        // Close others
        Object.values(dropdowns).forEach(d => d.classList.remove('open'));
        backdrop.classList.remove('active');
        
        if(dropdowns[id]) {
            dropdowns[id].classList.add('open');
            backdrop.classList.add('active');
            document.body.classList.add('mega-menu-open');
            
            // Reset State on Open: No Active Sidebar, No Active Panel
            const activeSidebar = dropdowns[id].querySelectorAll('.cmm-sidebar-link.active');
            activeSidebar.forEach(el => el.classList.remove('active'));
            const activePanels = dropdowns[id].querySelectorAll('.cmm-submenu-panel.active');
            activePanels.forEach(el => el.classList.remove('active'));
            // Reset Middle Column
            const middleCols = dropdowns[id].querySelectorAll('.cmm-col-middle');
            middleCols.forEach(el => el.classList.remove('active'));
        }
    }

    // Function: Trigger Sidebar Item
    function activateSidebar(wrapper, link) {
        if(!link) return;
        const handle = link.getAttribute('data-handle');
        
        // Links
        wrapper.querySelectorAll('.cmm-sidebar-link').forEach(l => l.classList.remove('active'));
        link.classList.add('active');

        // Panel Parent & Panels
        const parentCol = wrapper.querySelector('.cmm-col-middle');
        wrapper.querySelectorAll('.cmm-submenu-panel').forEach(p => p.classList.remove('active'));
        
        const target = wrapper.querySelector('#panel-' + handle);
        if(target) {
             target.classList.add('active');
             if(parentCol) parentCol.classList.add('active');
        } else {
             if(parentCol) parentCol.classList.remove('active');
        }
    }

    // LISTENER: Tab Enter
    tabs.forEach(tab => {
        tab.addEventListener('mouseenter', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            openDropdown(tab.getAttribute('data-target'));
        });
    });

    // LISTENER: Global Leave
    root.addEventListener('mouseleave', () => {
        Object.values(dropdowns).forEach(d => d.classList.remove('open'));
        backdrop.classList.remove('active');
        tabs.forEach(t => t.classList.remove('active'));
        document.body.classList.remove('mega-menu-open');
    });

    // LISTENER: Sidebar Hover
    document.querySelectorAll('.cmm-dropdown-wrapper').forEach(wrapper => {
        const links = wrapper.querySelectorAll('.cmm-sidebar-link');
        links.forEach(link => {
            link.addEventListener('mouseenter', () => {
                activateSidebar(wrapper, link);
            });
        });
    });
    // LISTENER: Backdrop Hover (Close Menu when drifting off grid)
    backdrop.addEventListener('mouseenter', () => {
        Object.values(dropdowns).forEach(d => d.classList.remove('open'));
        backdrop.classList.remove('active');
        tabs.forEach(t => t.classList.remove('active'));
        document.body.classList.remove('mega-menu-open');
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const wrapper = document.querySelector('#cmm-wrapper');
    let lastScrollY = window.pageYOffset;
    const stickyThreshold = 200;

    window.addEventListener('scroll', () => {
        const currentScrollY = window.pageYOffset;
        
        if (currentScrollY > stickyThreshold) {
            wrapper.classList.add('is-sticky');
            
            if (currentScrollY > lastScrollY && currentScrollY > stickyThreshold + 50) {
                // Scrolling down - hide
                wrapper.classList.add('sticky-hidden');
            } else {
                // Scrolling up - reveal
                wrapper.classList.remove('sticky-hidden');
            }
        } else {
            wrapper.classList.remove('is-sticky');
            wrapper.classList.remove('sticky-hidden');
        }
        
        lastScrollY = currentScrollY;
    }, { passive: true });
});
</script>
{% endif %}
